---
title: 凹凸纹理
tags:
  - Shader
  - Shader入门
  - 纹理
categories:
  - [技术美术, UnityShader]
author:
  - nightstardawn
---

# 凹凸纹理

## 一、凹凸纹理的作用和原理

- 纹理除了可以用来进行颜色映射外，另外一种常见的应用就是进行凹凸映射，凹凸映射的目的是使用一张纹理来修改模型表面的法线，让我们不需要增加顶点，而让模型看起来有凹凸效果。
- 原理:光照的计算都会利用法线参与计算，决定最终的颜色表现效果。那么在计算“假凹凸面时，使用“真”凹凸面的法线参与计算，呈现出来的效果可以以假乱真
- ![ 2024-09-04 093019.png](https://s2.loli.net/2024/09/04/6CxKAapqso3Mm8y.png)
- ![ 2024-09-04 093206.png](https://s2.loli.net/2024/09/04/cIijBZn4CVLdGX1.png)

## 二、主流实现的两种方式

### 1.高度纹理贴图

#### 1.）基本概念

高度纹理贴图一般简称高度图
它存储了模型表面上每个点的高度信息。
通常它使用灰度图像，其中不同灰度值表示不同高度。较亮区域通常对应较高的点，较暗的区域对应较低的点。
它主要用于模拟物体表面的位移

#### 2.）存储规则

图片中的某一个像素点的 RGB 值是相同的，都表示高度值，A 值一般高度值范围一般为 0~1，0 代表最低，1 代表最高情况下为 1。

#### 3.）优缺点

- 优点
  可以通过高度图很明确的知道模型表面的凹凸情况
- 缺点
  无法在 Shader 中直接得到模型表面点的法线信息而是需要通过额外的计算得到，因此会增加性能消耗，所以我们几乎很少使用它。

我们在使用凹凸纹理时，一般都会使用法线纹理贴

### 2.法线纹理贴图

#### 1.）基本概念

法线纹理贴图一般简称法线贴图 或 法线纹理它存储了模型表面上每个点的法线方向。

#### 2.）存储规则

图片中的 RGB 值分别存储法线的 X、Y、Z 分量值，A 值可以用于存储其他信息比如材质光滑度等。

#### 3.）优缺点

- 优点:从法线贴图中取出的数据便是法线信息，可以直接简单处理后就参与光照计算，性能表现更好
- 缺点:我们无法直观的看出模型表面的凹凸情况

#### 4.）读取规则

- 存储图片：像素分量 = (法线分量 + 1)/2
- 读取数据时：法线的分量 = 像素分量 \* 2 - 1

原因：法线的 XYZ 分量范围在[-1,1]之间
像素 RGB 的分量范围在[0,1]之间
因此我们需要进行映射运算

#### 5.）两种不同的存储方式

##### A、基于模型空间下的法线纹理

![ 2024-09-04 095625.png](https://s2.loli.net/2024/09/04/gPZLUrQsz9kjOJD.png)

1. 定义
   > 模型数据中自带的法线数据，是定义在模型空间中的，因此最直接的存储法线贴图数据的方式就是存储基于模型空间下的法线信息。
   > (注意:模型数据中的法线数据是“真”数据，法线贴图中对的法线数据是“假”数据)
2. 模型空间的法线为五颜六色的原因
   > 法线(0,1,0)映射到像素后(法线线量+1)/2 是(0.5,1.0.5)绿色
   > 法线(0,-1,0)映射到像素后(法线线量+1)/2 是(0.5,0,0.5)紫色
   > 因此基于模型空间的法线纹理一般是五颜六色的这种法线纹理贴图数据取出来直接参与 Shader 计算即可

##### B、基于切线空间下的法线纹理

![ 2024-09-04 095628.png](https://s2.loli.net/2024/09/04/GueJEUo2ymYST4l.png)

1. 什么时切线空间
   > 每个顶点都有自己的切线空间原点:顶点本身
   > X 轴:顶点切线
   > Z 轴:法线方向(顶点的原法线)
   > Y 轴:X 和 Z 的又乘结果，也被称为副切线
   > ![ 2024-09-04 101022.png](https://s2.loli.net/2024/09/04/3rxcKX7AStqpJMn.png)
2. 大部分为蓝色的原因
   > 在切线空间下，如果该顶点的法线不变化(不需要“凹凸感”)那么它的坐标是(0,0,1)，因为在切线空间下，Z 轴就是原法线方向.
   > 因此:
   > 法线(0,0,1)映射到像素后(法线分量+1)/2 是(0.5,0.5,1)浅蓝色
   > 这个浅蓝色就是 切线空间下法线贴图 存在大片蓝色的原因
   > 因为大部分顶点的法线和模型本身法线是一致的只有凹凸部分的颜色才会有些许差异
   > 这种法线纹理贴图数据取出来后需要进行坐标空间转换再参与 Shader 计算

##### C、建议使用切线空间下的法线纹理贴图的原因

- 可以用于不同的模型处理——如果模型空间下的法线，不可以用于其他模型
- 方便处理模型变形——同上
- 可以复用——一个砖块，6 个面的贴图都一样，可以只用一张法线贴图，即可用于六个面的计算
- 可以压缩——可以只存储两个轴的分量
- 方便制作 UV 动画——UV 坐标改变可以实现凹凸移动效果，如果时模型下法线贴图会有问题等等

## 三、法线贴图的计算方式

### 1.两种主流的计算方式

实现凹凸效果---主要就是使用基于切线空间的法线贴图中的法线信息参与到光照计算中

因此在计算光照模型时，通常有两种选择

- 切线空间下进行光照计算
  需要将光照方向、视角方向变换到切线空间下参与计算
- 世界空间下进行光照计算
  需要将法线方向变换到世界空间下参与计算

### 2.两种主流的计算方式的优缺点

- 效率
  - 切线空间中计算，效率高。
    因为矩阵的变换在顶点着色器中进行
  - 世界空间中计算，效率低。
    因为矩阵变换在片元着色器中进行
- 全局效果
  - 切线空间中计算，全局效果表现可能会不够准确
    例如：处理镜面反射、环境映射效果时表现效果可能不够准确
  - 世界空间中计算，全局效果表现更准确
    可以更容易的应用于全局效果

**注意：** 根据需求不同的计算方式，没有全局效果要求时，多使用切线空间下计算

### 3.切线空间下的计算方式

#### 1.）关键点

> **计算 模型空间->切线空间 的变换矩阵**
> 变换矩阵为子到父的<img src="https://s2.loli.net/2024/09/04/DHOtVQnifyxMhJT.png" alt="2024-09-04 160119.png" width="71" height="47">逆矩阵
> 由于我们主要使用变换矩阵来进行矢量变换而非点的变换，因此可以变为 3X3 的矩阵<img src="https://s2.loli.net/2024/09/04/d91zkA3aMVJ24lu.png" alt="2024-09-04 160502.png" width="57" height="48">
> 而 x、y、z 轴分别为切线空间中顶点的切线、副切线、法线
> 其中切线、法线可以从模型数据中获取，副切线为切线，法线的叉乘，并且三个轴是互相垂直的单位向量，因此<img src="https://s2.loli.net/2024/09/04/d91zkA3aMVJ24lu.png" alt="2024-09-04 160502.png" width="57" height="48">是正交矩阵
> 因此改变换矩阵的逆矩阵为<img src="https://s2.loli.net/2024/09/04/d91zkA3aMVJ24lu.png" alt="2024-09-04 160502.png" width="57" height="48">的转置矩阵

#### 2.）计算时的核心知识

- 得到模型空间光的方向 ：ObjectSpaceLightDir(模型空间顶点坐标)
- 得到模型空间视角的方向 ：ObjectSpaceViewDir(模型空间顶点坐标)
- 得到俩方向后 与 变换矩阵 进行矩阵运算，再参与后续切线空间下的计算

### 4.世界空间下的计算方式

#### 1.）关键点

> **计算 切线空间->世界空间 的变换矩阵**
> 变换矩阵为子到父的变换<img src="https://s2.loli.net/2024/09/04/DHOtVQnifyxMhJT.png" alt="2024-09-04 160119.png" width="71" height="47">
> 由于我们主要使用变换矩阵来进行矢量变换而非点的变换，因此可以变为 3X3 的矩阵<img src="https://s2.loli.net/2024/09/04/d91zkA3aMVJ24lu.png" alt="2024-09-04 160502.png" width="57" height="48">
> 而 x、y、z 轴分别为切线空间中顶点的切线、副切线、法线
> 我们只需要得到三个轴相对世界空间下的向量表达，即可以得到改矩阵

#### 2.）计算时的核心知识

- 法线从模型空间到世界空间 ：UnityObjectToWorldNormal(模型空间法线数据)
- 切线从模型空间到世界空间 ：UnityObjectToWorldDir(模型空间切线数据)
- 世界空间的副切线 ：上面计算结果叉乘即可
- 由上面三个计算得到的向量 组成变换矩阵<img src="https://s2.loli.net/2024/09/04/d91zkA3aMVJ24lu.png" alt="2024-09-04 160502.png" width="57" height="48">

## 四、关键注意点

### 1.模型空间下的切线数据

> 模型数据中的切线数据为 float4 类型，其中的 W 表示副切线的方向
> 原因：
> 用法线和切线叉乘得到的副切线有两条，用切线数据中的 W 与之相乘确定副切线的方向

### 2.Unity 当中的法线纹理类型

> 当我们把纹理类型设置为 Normal map(法线贴图时),我们可以使用 Unity 提供的内置函数 UnpackNormal 来得到正确的法线方向。该函数不仅可以进行`法线分量=像素分量 * 2 - 1`的逆运算，还会进行解压运算(Unity 会根据不同平台对法线纹理进行压缩)

### 3.法线纹理的命名

> 法线纹理属性一般命名为\_BumpMap(凸块贴图)
> 同时还会声明一个名为\_BumpMap（凸块缩放）的 float 属性---主要是用于控制凹凸度

### 4.高度纹理的处理办法

1. 将图片类型设置为 Normal Map(法线贴图)
2. 勾选 Creat form Grayscale(从灰度创建)

- 多出的 Bumpniess(颠簸值)---控制凹凸程度
- Filtering(过滤模式)---决定凹凸程度的算法
  - Sharp 滤波生成法线
  - Smooth 光滑的生成法线
