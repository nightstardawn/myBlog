---
title: 光照衰减
tags:
  - Shader
  - Shader基础
  - 光源
categories:
  - [技术美术, UnityShader, 光照]
author:
  - nightstardawn
---

# 光照衰减

## 一、定义与类型

### 1.定义

光照衰减通常是指在渲染过程中考虑光照在空间中传播时的减弱效应
例如：
任何光源的光照亮度会随着物体离光源的距离增加而迅速衰减

### 2.常见的光线衰减的计算方式

1. 线性衰减
   光强度和距离成线性关系。即：光照衰减与光源到被照射表面的距离成正比。
2. 平方衰减
   光强度和距离的平方成反比。这种模型更加符合现实世界中光照的特性，因为光在空间中的传播通常会遵循平方衰减规律

## 二、Unity 中的光照衰减

Unity 中为了提升性能，我们一般不会直接通过数学公式计算光照衰减
而是使用一张纹理作为查找表(LUT,lookup table) 在片元着色器中计算逐像素光照的衰减

Unity Shader 中有一个内置的纹理类型变量 `\_LightTexture0`
该纹理中存储了衰减值相关数据
Unity 内部预先计算好了相关数据 并存了改纹理中，避免重复计算，提升性能

其中：

- 对角线
  表明了光源空间的中不同位置的点对应的衰减值
- 起点
  表示和光源重合的点的衰减值
- 终点
  表示光源空间中离光源最远的点的衰减值

一般我们直接从`\_LightTexture0` 中进行纹理采样后，利用其中的 `UNITY_ATTEN_CHANNEL` 宏来得到衰减值

```cs
tex2D(_LightTexture,对应纹理的UV坐标).UNITY_ATTEN_CHANNEL
```

**注意：**
如果光源存在 cookie，也就是灯光遮罩
那么衰减值纹理就是 \_LightTextureB0

## 三、光源空间变化矩阵

Unity Shader 中 内置的光源空间变换矩阵
将世界空间下的位置转化到光源空间下

- 老版本：\_LightMatrix0
- 新版本：unity_WorldToLight

由于我们需要从 \_LightTexture0 光照纹理中取出对应的衰减数据
因此我们需要将顶点位置从世界空间转化到光源空间中
然后再来从中取出衰减数据

通过矩阵变换的形式来 将顶点从世界空间中转化到光源中

```cs
mul(unity_WorldToLight,float4(worldPos,1))
```
